<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <title>Chatbot</title>
    <style> 
    .chat {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    </style>
  </head>
  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">
 
      
      function ChatInput({chatMessages,setChatMessages}) {

        const [inputText, setInputText] = React.useState('');
        const [isLoading, setIsLoading] = React.useState(false);

        function saveInputText(event){
          setInputText(event.target.value);
          //inputText = event.target.value;
        }
         function handleKeyDown(event){
          if (event.key ==="Enter") {
             sendMessage();
          }
          else if (event.key ==="Escape") {
             setInputText('');
          }

        }
        async function sendMessage() {

          if (isLoading || inputText === '') {
            return;
          }
          // Set isLoading to true at the start, and set it to
          // false after everything is done.
          setIsLoading(true);

          // We can put this at the top of the function or
          // after the first setChatMessages(). Both work.
          setInputText('');
        
          const newChatMessages = [
                                    ...chatMessages,
                                     {
                                      id : crypto.randomUUID(),
                                      message: inputText,
                                      sender: "user"
                                    }];

          setChatMessages([
            ...newChatMessages,
            // This creates a temporary Loading... message.
            // Because we don't save this message in newChatMessages,
            // it will be remove later, when we add the response.
            {
              message: 'Loading...',
              sender: 'robot',
              id: crypto.randomUUID()
            }
          ]);

          const response = await Chatbot.getResponseAsync(inputText);
          setChatMessages([
            ...newChatMessages,
              {
              id : crypto.randomUUID(),
              message: response,
              sender: "robot"
              }
            ]);
            setIsLoading(false);

        }
        return (
          <>
          <input placeholder="Send a message to Chatbot" size="30"
           onChange={saveInputText}
           value={inputText}
           onKeyDown={handleKeyDown}
          />
          <button
          onClick={sendMessage}
          >Send</button>
          </>
        );
      }

      function ChatMessage({message, sender}) {
    
       return (
          <div>
            {sender ==='robot' && <img src="robot.png" width="50" />}
            {message}
            {sender ==='user' && 
            (<img src="user.png" width="50" />

            )}
          </div>
       )

      }

      function ChatMessages ({chatMessages}) {
      
            return (
              <>
              {chatMessages.map((chatMessage) =>{
                  return (<ChatMessage message={chatMessage.message} sender={chatMessage.sender} key={chatMessage.id}/>);
                })}
              </>
            )
      }

      function App () {
            const [chatMessages, setChatMessages] = React.useState([]);

          return (
            <> 
              <ChatInput chatMessages={chatMessages} setChatMessages={setChatMessages}/>
              <ChatMessages chatMessages={chatMessages} />           
            </>  
        );
      }
      
      const container = document.querySelector('.js-container');
      ReactDOM.createRoot(container).render(<App />);

    </script>

  </body>
</html>